# 互联网的组成

## 边缘部分

> 由所有连接在互联网上的主机组成.这部分是由**用户直接使用的**,用来进行通信(传送数据,音频或者视频)和资源共享

- 处在互联网边缘上部分就是连接在互联网上的所有主机，这些主机又称为**端系统**
- 主机A和主机B进行通信实际上指**运行在主机A上的某个程序和运行在主机B上的另一个程序进行通信**,即主机A的某个进程和主机B上的另一个进程进行通信,简称**计算机通信**

## 核心部分

> 由大量网络和连接这些网络的路由器组成,**这部分是为边缘部分提供服务的(提供连通性和交换)**

# 端系统之间的两种通信方式(边缘部分)

## 客户-服务器方式(C/S方式)

>  即Client/Server方式,简称C/S方式
>
> 客户是发送请求的,服务器再去响应客户的请求
>
> 客户需要知道服务器的地址,但是服务器不需要知道客户的地址
>
> 客户与服务器的通信关系建立后,==通信是双向的==,都可发送和接受数据

## 对等方式(P2P方式)

> 即peer-to-peer方式,简称P2P方式

* 对等连接是指两个主机在通信时并不区分哪一个是服务请求还是服务提供方
* 只要两个主机都运行了对等连接软件(P2P软件),他们就可以进行**平等的,对等连接通信**
* 双方都可以下载对方已经存在在硬盘的共享文档
* 对等连接方式从本质上看仍然是使用客户服务方式,知识对等连接中的每一个主机即是客户又是服务器

# 互联网的核心部分

* 在网络核心部分起特殊作用的是==路由器==
* 路由器是实现==分组交换==的关键构件,其任务是==转发==收到的分组,这是网络核心部分最重要的功能.

## 电路交换

### 特点

* 两部电话只需要一根电话线就能互相沟通,如果是N部电话机两两直接相连,需要==N(N-1)/2==对电话线.这种直接连接方法所需要的电线对的数量与电话机数量的平方(N的平方)成正比
* 当电话机数量增多的时,就要使用==交换机==来完成全网的交换任务,这个所采用的交换任务就是==电路交换==
* 电路交换必定是==面向连接==的
* 电路交换始终占用端到端之间的通信资源

### 交换的含义

* 在这里交换的含义就是转接,把一条电话线转接到另外一条电话线,使得他们之间连通起来
* 从通信资源的分配角度来看,交换就是按照某种方式==动态地分配==传输线路的资源

### 电路交换的阶段

1. **建立连接**:建立一条专用的物理通路,以保证双方通话时所需要的通信资源在通信时不会被其他用户占用
2. **通信**:主叫和被叫双方就能互相通话
3. **释放连接**:释放刚才使用的这条专用的物理通路(释放刚才占用的所有通信资源).

### 缺点

1. 计算机数据具有突发性
2. 在传送计算机数据时,通信线路的利用率很低,用来传送数据的时间往往不到10%,甚至1%

## 分组交换

### 特点

* 分组交换则采用==存储转发==技术
* 在发送端,先把较小的保温==划分成较短的,固定长度数据端==

- 在每一个数据端前面添加上==首部==构成==分组==
- 每一个分组的首部都含有地址(诸如目的地址和源地址)等控制信息.
- 分组交换网中的节点交换机根据收到的分组中的==地址信息==,把分组==转发==到下一个节点交换机
- 每个分组在互联网中==独立地选择传输路径==
- 存储的过程每到一个节点,先要思考往哪送,这是存储的过程,然后在转发

### 优点

1. 高效:在分组传输的过程中==动态分配==传输带宽,对通信链路是逐段占用
2. 灵活:为每一个分组==独立==选择最合适的转发路由
3. 迅速:以分组作为传送单位,可以==不先建立连接==就能向其他主机发送分组
4. 可靠: 保证可靠性的网络协议,分布式多路由的分组交换网,使网络有很好的生存性

### 缺点

1. 分组在各节点存储转发时需要排队,这就会造成一定时延
2. 分组必须携带的首部(里面有必不可少的控制信息)也造成了一定的开销

## 路由器

* 在路由器中的输入和输出端口之间没有直接连线

### 路由器处理分组的过程

1. 把收到的分组先放入==缓冲(暂时存储)==
2. ==查找转发表==,找出到某个目的地址应从哪个端口转发
3. 把分组送到适当的端口==转发==出去
4. 分组是对象,存储转发是方式

## 报文交换

# 计算机网络分类

## 网络作用范围分类

1. 广域网(wan)(Wide Area Network)
2. 域域网(MAN)(Metropolitan Area Network)
3. 局域网(LAN)(Local Area Network)
4. 个人局域网(PAN)(Personal Area Network)

> 若中央处理机之间的距离非常近(如仅一米的数量级甚至更小些),则一般称作==多处理机系统==,而不称它为计算机网络

## 网络使用者分类

1. 公用网(public Network)
2. 专用网(private Network)
3. 用来把用户接入互联网的是接入网(AN)(Access Network),接入网是从某个用户端系统到互联网中的**第一个路由器**（也称为边缘路由器）之间的一种网络,从作用来看,也就是在用户和互联网之间当桥梁作用.

# 计算机网络性能

## 性能指标

1. 速率
2. 带宽
3. 吞吐率
4. 时延
5. 时延带宽积
6. 往返时间RTT
7. 利用率

## 速率

概念

> 速率是计算机网络中重要的一个性能指标,指的是==数据的传送速率==,它也称为==数据率==或==比特率==

* 速率的单位是bit/s,kbit/s......
* 从kb到b是1024增加,但是kbit/s到bit/s是10的3次方
* 速率往往是指额定速率,并非实际运行速率

## 带宽

带宽是指每秒能通过的数据量

## 吞吐量

**吞吐量**和**带宽**相关

## 时延

组成:

1. 发送时延
   $$
   发送时延=\frac{数据帧长度(bit)}{(发送速率(bit/s)}
   $$
   
2. 传播时延


$$
传播时延=\frac {信道长度(米)}{信号在信道上的传播速率(米/秒)}
$$


3. 处理时延

4. 排队时延

   

 ## 时延带宽积

$$
时延带宽积={传播时延}*{带宽}
$$

## 往返时间

* 往返时间表示从发送方发送数据开始,到发送方收到来自接受方的确认,总共经历的时间.
* 在互联网中,往返时间还包括各中间结点的处理时延,排队时延以及转发数据时的发送时延
* 当使用卫星通信时,往返时间RTT相对较长,是很重要的一个性能指标

## 网络利用率

$$
D=\frac {D_0}{1-U}
$$

* U是网络的利用率,数值在0~1之间
* 利用率不是越大越好

# 计算机网络体系结构

* 开放系统互连基本参考模型OSI

## 网络协议

组成要素

* 语法:数据与控制信息的结构或格式
* 语义:需要发出任何控制信息,完成何种动作以及做出何种响应
* 同步:事件实现顺序的详细说明

## 主机与主机之间的通信分成三个模块

* 文件传送模块

* 通信服务模块

* 网络接入模块

  > 好处 
  >
  > * 各处之间是独立的
  > * 灵活性好
  > * 结构上可分割开
  > * 易于实现和维护
  > * 能促进标准化工作
  >
  > 缺点:
  >
  > * 降低效率
  > * 有些功能会在不同的层次中重复出现,因而产生了额外开销

## 网路该分多少层

### 各层完成的主要功能

1. 差错控制:**使相应层次对等方的通信更加可靠。**
2. 流量控制:**发送端的发送速率必须使接收端来得及接收，不要太快**
3. 分段和重装:l**发送端将要发送的数据块划分为更小的单位，在接收端将其还原。**
4. 复用和分用:l**发送端几个高层会话复用一条低层的连接，在接收端再进行分用。**
5. 连接建立和释放:**交换数据前先建立一条逻辑连接，数据传送结束后释放连接。**

  ### 五层体系结构

1. OSI的七层协议
2. TCP/IP的四层协议
3. 五层协议

# 物理层

## 1.基本概念

* 物理层考虑的是怎样才能在连接各种计算机的传输媒体上和传输媒体上传输数据比特流,而不是指具体的传输媒体

### 物理层的主要任务

1. **机械特性**: 指明接口所用接线器的形状和尺寸,引脚数目和排列,固定和锁定装置等.平时常见的各种规格的接插件都有严格的标准化的规定
2. **电气特性**:知名在接口电缆上的各条线上出现的电压的范围
3. **功能特性**:指明某条线上出现的某一电平的电压意义.
4. **过程特性**:指明对于不同功能的各种可能事件的出现顺序.

### 常用术语

* **数据**:运送消息的实体
* **信号**:数据的电气或电磁的表现
* **模拟信号**:代表消息的参数的取值是连续的
* **数字信号**:代表消息的参数的取值是离散的
* **码元**::在使用时间域的波形表示数字信号时,代表不同离散数值的基本波形

### 信道基本概念

* **信道**:一般用来表示向某个方向传送信息的媒体
* **单向通信**:只能有一个方向的通信而没有反方向的交互
* **双向交替通信(半双工通信)**--通信的双方都可以发送消息,但不能双方同时发送(当然也不能同时接收)
* **双向同时通信(全双工通信)**:通信的双方可以同时发送和接收消息
* ==注意==:双向交替通信和双向同时通信需要两条信道,一条用来发送,一条用来接收
* **基带信号**:来自信源的信号哦,像计算机输出的代表各种文字或图像文件的数据信号都属于基带信号
* 基带信号往往都包含许多低频信号,甚至有直流成分,而许多信道并不能传输这种低频分量或直流分量.因此必须对基带信号进行==调制==

### 调制分类

1. **基带调制**:仅对基带信号的波形进行变换,使它能够与信道特性相适应.**变换后的信号仍然时基带信号**,把这种过程称为编码
2. **带通调制**:使用**载波**进行调制,把基带信号的频率范围搬移到较高的频段,并**转换为模拟信号**,这样能够更好的在模拟信道中传输(即仅在一段频率范围内能够通信)
3. **带通信号**:经过载波调制后的信号

### 常用编码方式

1. 不归零制
2. 归零制
3. 曼彻斯特
4. 差分曼彻斯特

### 基本带通调制方法

1. 调幅
2. 调频
3. 调相 

### 信道的极限容量

限制因素:

* 信道能够通过的频率范围
* 信噪比

$$
信噪比(dB)=10 log_2(S/N)(dB)
$$

#### 香农公式

$$
C=W log_2(1+S/N)(bit/s)
$$

W为信道的带宽(以Hz为单位)

S为信道内所传信号的平均功率

N为信道内部的高斯噪声功率

* ==香农公式表明信道的带宽或信道中的信噪比越大,信息的极限速率越高==

#### 注意

* 对于频带宽度已确定的信道,如果信噪比不能再提高了,并且码元传输速率也达到了上限值,那么还有办法提高信息的传输速率
* **用编码的方法让每一个码元携带更多比特信息量**

## 物理层下面的传输媒体

### 导引型传输媒体(书P47)

* 双绞线是最常用的
* 同轴电缆:很好的抗干扰特性,被广泛引用于传输较高速率的数据
* 光纤:$10^8$MHZ

### 非导引型传输媒体(P51)

* 短波通信(高频通信):主要是靠电离层的反射,但短波通信的通信质量较差,传输速率低
* 微波:在空间主要是直线传播
* 传统微波通信有两种方式:
* * 地面微波接力通信
  * 卫星通信                                          

## 信道复用技术

### 频分复用,时分,统计时分

* **频分复用**:再同样的时间占用不同的带宽资源,(带宽是指频率带宽)
* **时分复用**:在不同的时间占用相同的带宽资源

### 码分复用(CDM)(习题2-16)

* 常用的名词是**码分多址**(CDMA)

* 个用户使用经过特殊挑选的不同码型,彼此之间不会造成影响
* 这种系统发送的信号有很强的抗干扰能力,频谱类似于白噪声,不易被敌人发现

#### 码片序列(P57)

* 每一个比特时间划分为m个短的间隔,称为码片
* 每个站被指派为一个唯一的m bit码片序列
  * 发送比特1,则发送自己的m bit码片序列
  * 发送比特0,则发送它的反码
  * 计算的时候变成**0为-1**,**1为+1**
  * 码片序列扩大了频率
* 规格化内积算出来是０，则这个站没发送数据
* 算出来是１，则是发送了它本身，比特１
* 算出来是０.则是发送它的反码，比特０

# 数据链路层

* 点对点信道:一对一
* 广播信道:一对多

## 使用点对点信道的数据链路层

###  数据链路和帧

* **链路(物理链路**):是一条无源的点对点的物理线路段,中间没有任何其他的交换结点
* **数据链路(逻辑链路)**:除了物理线路外,还必须有通信协议来控制这些数据的传输.若把实现这些协议的硬件和软件加到链路上,就构成了数据链路
  * 现在最常使用的方法是使用适配器(即网卡)来实现这些协议的硬件和软件
  * 一般的适配器都包括了数据链路层和物理层这两层功能

### 三个基本问题

数据链路层有许多协议,但是有三个问题是共同的:

1. **封装成帧**
2. **透明传输**
3. **差错控制**

### 封装成帧(P72)

书P72

### 透明传输(P73)

* 解决方法:**字节填充法**,前面加上转义字符

### 差错控制(P74)

* 传输过程中可能会出现**比特出错**
* 传输错误的比特占传输比特总数的比率称为误码率BER(Bit error Rate)
* 解决方法:使用**循环冗余检验**(P74)

### 可靠传输

1. 不重复
2. 不丢失
3. 不失序

## 点对点协议PPP

* 应该满足的需求:
 1. 简单
  2. 还有上面的三个基本问题
  3. 多种网络协议:能够在同一条物理链路上同时支持多种网络层协议
  4. 多种类型链路:能够在多种类型的链路上运行
  5. 检测链接状态
  6. 最大传送单元
  7. 网络层地址协商
  8. 数据压缩协商

* 不需要的功能:
  1. 纠错
  2. 流量控制
  3. 序号
  4. 多点线路
  5. 半双工或单工链路

### 组成

1. 一个将IP数据报封装到串行链路的方法
2. 链路控制协议LCP
3. 网络控制协议NCP
4. ==P是指protocol---协议==

### 透明传输问题

* 当在同步传输链路时,协议规定采用硬件来完成==比特填充==(和HDLC的做法一样)
* 在异步传输时,就使用一种特殊的==字符填充法==

### 不提供使用序号和确认的可靠传输

* PPP协议之所以不使用序号和确认机制是出于以下的考虑
  * 在数据链路层出现差错的概率不大时,使用比较简单的PPP协议较为合理
  * 在因特网环境下,PPP的信息字段放入的数据是IP数据报.数据链路层的可靠传输并不能够保证网络层的传输也是可靠的
  * 帧检验序列FCS字段可保证无差错接受

### 字符填充(P79)

### 0比特填充(P80)

## 使用广播信道的数据链路层

### 局域网的数据链路层

* 局域网最主要的特点:
  * 网络为一个单位所拥有
  * 地理范围和站点数目均有限
* 优点:
  * 具有广播功能,从一个站点可方便的访问全网,局域网上的主机可共享连接在局域网上的各种硬件和软件资源
  * 便于系统的扩展和逐渐地演变,各设备的位置可灵活调整和改变
  * 提高了系统的可靠性,可用性和残存性

### 媒体共享技术

#### 静态划分信道

* 时分复用
* 频分复用
* 波分复用
* 码分复用

#### 动态媒体接入控制(多点接入)

* 随机接入
* 受控接入,如多点线路探询,或轮询

### 适配器

* 网络接口板又称为通信适配器或网络接口卡(NIC),或网卡
* 重要功能
  * 进行串行/并行转换
  * 对数据进行缓冲
  * 在计算机的操作系统安装设备驱动程序
  * 实现以太协议

### ==CSMA/CD 协议(含义:载波监听多点接入/碰撞检测)==(P86)

总线特点:

> 当一台计算机发送数据时,总线上的所有计算机都能检测到这个数据,这种就是广播方式.

* 为了在广播中实现一对一的通信,我们可以使每一台计算机的适配器拥有一个与其他适配器都不同的地址.
* 在发送数据帧时,帧的首部写明接收站的地址,仅当数据帧中的目的地址与适配器ROM中存放的硬件地址一致时,该适配器才能接受这个数据帧,如果不是发送自己的数据帧就丢失.

#### 通信方便,以太网采取了两种重要的措施

1. 采用较为灵活的无连接的工作方式(P85)
2. 以太网发送的数据都是用曼彻斯特编码
   * 缺点:它所占的频带宽度比原始的基带信号增加了一倍

#### 碰撞检测(P87)

* 在使用CSMA/CD协议时,一个站不可能同时进行发送和接受(但必须便发送边监听信道),因此使用CSMA/CD协议的以太网不太可能进行全双工通信,而只能进行双向交替通信

##### 争用期

* 最先发送数据帧的站,在发送数据帧至多经过时间2倍==涛==(两倍的端到端往返时延)就可知道发送的数据帧是否遭到了碰撞.
* 以太网的端到端往返时延2涛称为**争用期**,或碰撞窗口
* 经过争用期这段时间还没有检测到碰撞,才能可定这次发送不会发送碰撞

##### 二进制指数类型退避算法(P88)

* 发送碰撞的站在停止发送数据后,要推迟一个**随机时间**才能在发送数据
* 最短有效帧长是64字节

> 先听后发
>
> 边听边发
>
> 冲突停止
>
> 延迟重发

### 使用集线器的星形拓扑(P90)

### 以太网信道利用率(P92)

### 以太网的MAC层(P93)

* 硬件地址又称为物理地址或MAC地址
* 802标准所说的地址严格地讲应当是每一个站地"**名字**"或"**标识符**"
* 地址是48位
* 无效地MAC层:
  * 数据字段的长度与长度字段的值不一致
  * 帧的长度不是整数个字节
  * 用收到的帧检验序列FCS查出有差错
  * 数据字段的长度不在46~1500字节之间
  * 有效的MAC帧长度为64~1518字节之间

## 扩展的以太网(P97)

### 物理层:

* 使用光纤扩展
* 使用集线器扩展(级联)

### 数据链路层

* 早期使用网桥
* 现在使用以太网交换机
* 在以太网交换机产生的环路,所以有了STP生成树协议,解决这个循环问题

### 虚拟局域网(P101)

* 在数据链路层,加了Vlan标签的网络,不能和其他vlan标签通信
* ==结论:只要是在处在不同网络,交换机就不能在数据链路层对于不同网络的计算机传数据==

## 高速以太网(P103)

# 网络层

## **数据链路层没有解决的两个问题**

* 可靠传输
* 在不同的网络环境下,怎么进行数据的传输

## 网络层提供的两种方法

* 第一种是在发送数据前建立一条虚电路

* 虚电路实现起来不太现实,就是==网络提供数据报服务==,但它不能保障可靠传输,这样子网络造价大幅降低,运行方式灵活,能够适用多种应用

## 网络协议IP

### 配套使用的三个协议

1. 地址解析协议ARP
2. 网际控制报文协议ICMP
3. 网际组管理协议IGMP
4. ==重点在前两个协议==

## 虚拟互联网络

* 要想将全世界这么多的计算机进行连接,那么就要解决许多问题,详情问题看**书P116**
* 将互联网连接起来,需要用到一些中间设备
  * 物理层:**转发器**
  * 数据链路层:**网桥或者桥接器**
  * 网络层:**路由器**
  * 网络层以上:**网关**

### 意义

> 使用IP协议的虚拟互联网可简称IP网
>
> 当互联网上的主机进行通信时,就好像在一个网络上通信一样,而看不见互连的各具体的网络异构协议
>
> 如果在这种覆盖全球的IP网的上层使用TCP协议,那么就时现在的互联网

## 本部分重要学习的部分

* IP地址及其表示方法
* 常用的三种类别的IP地址

## IP地址及其表示方法

> IP地址就是给每个连接在互联网上的主机(或路由器)分配一个在全世界范围时唯一的32位的标识符
>
> IP地址现在由互联网名字和数字分配机构

### IP地址的编制方法

1. 分类的IP地址
2. 子网的划分
3. 构成超网

###　分类的IP地址

* 将IP地址划分为若干个固定类
* 由两个固定长度的字段组成:

  * net-id(网络号):主机所连接的网络
  * host-id(主机号):标识该主机或路由器
* 主机号在它前面的网络号所指明的网络范围是唯一的
* 由此可见,**一个IP地址在整个互联网范围内时唯一的**

### IP地址一些重要特点

1. IP地址是一种分等级的地址结构,分两个等级的好处是
   * 第一,IP地址管理机构在分配IP地址只分配网络号,剩下的主机号有得到该网络号的单位自行分配,方便IP地址的管理
   * 第二,路由器仅根据目的主机所连接的网络号来转发分组(而不考虑目的主机号),这样就可以使路由表中的项目数大幅度减少,从而减少路由表所占的存储空间
2. 实际上IP地址是标志一个主机(或路由器)和一条链路的接口
   * 当一个主机同时连接到两个网络上时,该主机就必须具有两个相应的IP地址,其网络号net-id必须是不同的,该主机称为**多归属主机**
   * 由于一个路由器至少应当连接到两个网络(这样才能将IP数据包从一个网络转发到另一个网络),因此一个**路由器至少应当由两个不同的IP地址
3. 用转发器或网桥连接起来的若干个局域网仍为一个网络,都具有同样net-id
4. 所有分配到网络号的网络,他们都是平等的,都是一样的

### IP地址与硬件地址

* IP地址与硬件地址是不同的位置
* IP地址是分配的,硬件地址是一个固定属性

## 地址解析协议ARP

![image-20210505085814385](https://i.loli.net/2021/06/12/tFdD3xMbK5u9rHk.png)

![image-20210505085958120](C:\Users\15461\AppData\Roaming\Typora\typora-user-images\image-20210505085958120.png)

![image-20210505090909281](https://i.loli.net/2021/06/12/dQJNwU6kAyMfD3c.png)

![image-20210505093521079](../../AppData/Roaming/Typora/typora-user-images/image-20210505093521079.png)

####　应当注意的问题

* ARP是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题
* 如果所要找的主机和源主机不在同一个局域网上,那么就要通过ARP找到一个位于本局域网上的某个路由器的硬件地址,然后把分组发送给这个路由器,让这个路由器分组转发给下一个网络.剩下的工作由下一个网络来做  
* 从IP地址到硬件地址的解析是自动进行的,主机的用户对这种地址解析过程是不知道的
* 只要主机或路由器要和本网络上的另一个已知IP地址的主机或路由器进行通信,ARP协议就会自动的将该IP地址解析为链路层所需要的硬件地址

#### 使用ARP的四种典型情况P127

## IP数据包的格式

> 一个IP数据包由**首部和数据**两个部分组成
>
> 首部的前一部分是固定长度,共20字节,是所有IP数据包必须具有的
>
> 在首部的固定长度,是一些可选字段

![image-20210505094146075](https://i.loli.net/2021/06/12/H5GEtOq2xau74SC.png)

### IP层转发分组的流程

![image-20210505104057125](https://i.loli.net/2021/06/12/CzXaRuW9sEk7Ffb.png)

![image-20210505105124152](https://i.loli.net/2021/06/12/qwJXhoGSaUObkcK.png)

![image-20210505105352937](https://i.loli.net/2021/06/12/KF6yHf2OrTYmtVQ.png)

## 划分子网和构造超网

### 划分子网的基本思路

* 划分子网纯属于一个单位内部的事情.单位仍表现为没有划分子网的网络

* 从主机号**借用**若干**个位**作为子网号subnet-id,而主机号host-id也就相应减少了若干**个位**

  ![image-20210505142809129](https://i.loli.net/2021/06/12/R4UTcOLmNu3Agid.png)

### 子网掩码

* 使用子网掩码可以找出IP地址中的子网部分
* 规则:
  * 子网掩码长度=32位
  * ==某位=1==:IP地址中的对应位为网络号和子网号
  * ==某位=0==:IP地址中的对应位为主机号
* (IP地址)AND(子网掩码)=网络地址
* IP地址和子网掩码做与运算来获取所要的子网的网络地址

![image-20210505144046771](https://i.loli.net/2021/06/12/QgSju5fM71TxFHE.png)

* 不同的子网掩码得出相同的网络地址.但不同的掩码的效果是不同的

### 使用子网时分组的转发

### 构成超网

![image-20210505152932780](https://i.loli.net/2021/06/12/S9IbrViXHPv21hE.png)

![image-20210505153101935](https://i.loli.net/2021/06/12/HafgWVLp9ruKcJN.png)

![image-20210505154143527](https://i.loli.net/2021/06/12/vPzoubN5GCJhAjT.png)

## 网际控制报文协议ICMP

### ICMP报文种类

> ICMP差错报告报文和ICMP询问报文
>
> ICMP报文前四个字节是统一的格式,共有三个字段,即类型,代码和校验和.接着的四个字节的内容与ICMP的类型有关

#### ICMP差错报告报文

* 终点不可达
* 时间超过
* 参数问题
* 改变路由(重定向)(Redirect)

#### 不应发送ICMP差错报告报文的几种情况

* 对ICMP差错报告报文不在发送ICMP差错报告报文
* 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
* 对具有多播地址的数据报都不发送ICMP差错报告报文

#### ICMP询问报文

* 回送请求和回答报文
* 时间戳请求和回答报文

* ![image-20210505164830345](C:\Users\15461\AppData\Roaming\Typora\typora-user-images\image-20210505164830345.png)

#### ICMP应用举例

* 有的服务器不回应ICMP服务,因为发送了ICMP请求,服务器就要回复它,如果发送的请求过多,服务器正常的服务就会被占用,这也是传统的DDOS攻击

## 互联网的路由选择协议

![image-20210507124607694](C:\Users\15461\AppData\Roaming\Typora\typora-user-images\image-20210507124607694.png)

![image-20210507124804484](C:\Users\15461\AppData\Roaming\Typora\typora-user-images\image-20210507124804484.png)

### 内部网关协议RIP(Routing information Protocol)

> 工作原理:
>
> 它是内部网关协议IGP中最先得到广泛使用的协议
>
> 他是一种==分布式的,基于距离向量==的路由选择协议
>
> Rip协议要求网络中的每一个路由器都要维护从他自己到其他每一个目的的网络的距离记录

* RIP认为一个好的路由就是它通过的路由器的数目少,即距离短.
* 它允许一条路径最多只包含15个路由器
* 距离的最大值为16时即相当于不可达,它只适用于小型互联网(当标记为16时,说明是不可达,即使中间只有一个路由器,它坏了,RIP也会标记为16,相当于不可达)
* 他不能在两个网络之间同时使用多条路由.

![image-20210507125728671](C:\Users\15461\AppData\Roaming\Typora\typora-user-images\image-20210507125728671.png)

![image-20210507130545248](C:\Users\15461\AppData\Roaming\Typora\typora-user-images\image-20210507130545248.png)

### 内部网关协议OSPF

![image-20210507130632308](C:\Users\15461\AppData\Roaming\Typora\typora-user-images\image-20210507130632308.png)

 ## ipv6

![image-20210507131331468](C:\Users\15461\AppData\Roaming\Typora\typora-user-images\image-20210507131331468.png)

![image-20210507131344131](../../AppData/Roaming/Typora/typora-user-images/image-20210507131344131.png)

![image-20210507131359023](../../AppData/Roaming/Typora/typora-user-images/image-20210507131359023.png)

![image-20210507131516648](https://i.loli.net/2021/06/12/5oHTjEYRGtdvfxA.png)

* 隧道技术相当于封装

# 运输层

* 基于端口的复用和分用

![image-20210515194641844](https://i.loli.net/2021/06/12/HE5lG1FbMYem8fS.png)

* 运输层采用面向连接的TCP协议时,尽管下面的网络时不可靠的(只提供尽最大努力服务),但是这种逻辑通信相当于一条全双共的可靠通信
* 采用UDP协议时,这种逻辑通信是一条不可靠信道

TCP与UDP

* 两个对等运输实体在通信时传送的数据单位叫作==运输协议数据单元==TPDU
* TCP传送的数据单位协议是TCP报文段(segment)
* UDP传送的数据单位协议是==UDP报文==或==用户数据报==

![image-20210515195637275](https://i.loli.net/2021/06/12/y6PJqNiCjzxB8fY.png)

## TCP/IP运输层端口

* 端口用一个16位端口号进行标志
* 端口号只具有本地意义,即端口号只是为了标记本计算机应用层中的各进程
* 服务器端使用的端口号
  * 熟知端口,数值一般为0~1023
  * 登记端口号,数值为1024~49151,为没有熟知端口号的应用程序使用的,使用这个端口号的必须在IANA登记,以免重复
* 客户端使用的端口号
  * 短暂端口号,数值为49152~65535,留给客户进程选择暂时使用
  * 当服务器进程收到客户进程的报文时,就知道了客户进程所使用的动态端口号.通信结束后,这个端口号可供其他客户进程以后使用

## UDP

> UDP只在IP数据报服务之上增加了很少一点功能:
>
> * 复用和分用的功能
> * 差错检测的功能
>
> 虽然UDP用户数据报只能提供不可靠的交付,但UDP在某些方面有其特殊的优点

特点:

* UDP是无连接的
* UDP使用尽最大努力交付
* UDP是面向报文
  * 一次交付一个完整的报文
  * 必须选择合适大小的报文,太长太短,在交给IP层的时候,都会降低IP层的效率
* UDP没有拥塞控制
* 支持n对n
* UDP的首部开销小,只有8个字节

## TCP

* 他是面向连接的运输层协议
* 每一条TCP连接只能有两个端点,每一条TCP连接只能是点对点的
* 它提供可靠交付的服务
* 提供全双工通信
* 面向字节流
* 它不保证双方的数据块有对应大小的关系,但要求双方发出的字节流完全一样 

注意:

* TCP连接是虚连接
* TCP对应用进程一次把多长的报文发送到TCP的缓存是不关心的
* 它根据对方给出的==窗口值==和当前==网络拥塞的程度==来决定一个报文段应包含多少字节(UDP发送的报文长度是应用进程给出的)
* 可把太长的数据块划分短一些再传送
* 也可等待积累有足够多的字节后再构成报文段发送出去

TCP的连接

* TCP连接的端点叫做套接字(Socket)或插口
* 端口号拼接到IP地址即构成了套接字

### 可靠传输的原理

* 停止等待协议(P213 )
* 连续ARQ协议(P216)

#### 连续ARQ协议

* 累计确认
* 回退机制

TCP可靠通信的具体实现

* TCP的连接每一个端口都必须设有两个窗口,一个发送窗口,一个接受窗口
* 可靠传输机制用==字节的序号==进行控制的,所有确认是基于序号而不是基于报文段
* TCP两端的四个窗口经常出狱动态变化中,TCP连接的往返时间RTT不是固定的,需要使用特定的算法估算合理的重传时间
* 确认号是期望收到对方的下一个报文段的数的第一个字节的序号,同一个报头中,序号和确认号没有关联

==注意==

* A的发送窗口并不总是和B的接收窗口一样大(因为有一定的时间滞后)
* TCP标准没有规定对不按序列达到的数据应如何处理,通常是先临时存放在接受窗口中,等到字节流中所缺少的字节收到后,再按序交付上层的应用进程.
* 要求接收方必须有`累计确认`的功能,可以减少传输开销 

![image-20210518193149010](https://i.loli.net/2021/06/12/sKPLWAjd1arQt9i.png)

